import datetime as dt

import numpy as np
import matplotlib.pyplot as plt

from hotel import Hotel
from market import Market
from revenue_managers import DOWRevenueManager, GammaRevenueManager

@profile
def run_simulation():
    hotel = Hotel(merchant_id=1, capacities={10: 100}, available_rooms=[10])
    #Prices for each DOW
    prices = {
        #10: {0: 80, 1: 80, 2: 80, 3: 80, 4: 100, 5: 110, 6: 80},
        10: {0: 80, 1: 80, 2: 80, 3: 80, 4: 80, 5: 80, 6: 80},
    }

    start_reserved_night_date = dt.datetime(2018, 12, 1)
    end_reserved_night_date = dt.datetime(2018, 12, 30)

    rm = DOWRevenueManager(prices=prices, hotel=hotel, start_reserved_night_date=start_reserved_night_date,
                           end_reserved_night_date=end_reserved_night_date)
    gamma_rm = GammaRevenueManager(prices=prices, hotel=hotel, gamma=10, drop_increase_fraction=0.10,
                                   target_occupancy=0.45, start_reserved_night_date=start_reserved_night_date,
                                   end_reserved_night_date=end_reserved_night_date)


    start_date = start_reserved_night_date
    end_date = end_reserved_night_date
    #print("star_Date_1",start_date,dt.datetime(2018,12,1))

    average_number_of_potential_customers = 100


    ### initialise number of customers, budget and interested date
    market = Market(
        start_reserved_night_date=dt.datetime(start_reserved_night_date.year, 1, 1),
        end_reserved_night_date=dt.datetime(end_reserved_night_date.year, 12, 30),
        average_number_of_potential_customers=average_number_of_potential_customers,
        minimum_budget_in_population=72,
    )
    market.initialize_market()


    ### iterate over days
    maximum_wtps = {}
    for delta in range((end_date-start_date).days):
        reserved_night_date = start_date + dt.timedelta(days=delta)
        #print("start_date",start_date,reserved_night_date)
        print("Processing", reserved_night_date)
        
        persons = market._create_persons(reserved_night_date)
        #print("here",persons)
        #maximum_wtps[reserved_night_date] = [person.budget for person in persons]

        rm = market.generate_bookings_for_reserved_night_date(reserved_night_date, rm, persons)
        #print(rm)
        #print("here")
        for person in persons:
            person.has_booked = False

        gamma_rm = market.generate_bookings_for_reserved_night_date(reserved_night_date, gamma_rm, persons)
        #print(rm)

    return rm._revenue, gamma_rm._revenue

if __name__ == '__main__':
    rm_revs = []
    gamma_rm_revs = []
    for i in range(1):
        print("Run: ", i)
        rm_rev, gamma_rm_rev = run_simulation()
        rm_revs.append(rm_rev)
        gamma_rm_revs.append(gamma_rm_rev)

    print(rm_revs)
    print(gamma_rm_revs)
